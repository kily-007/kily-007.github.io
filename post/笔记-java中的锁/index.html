<html>
<head>
    <meta charset="utf-8"/>
<meta name="description" content=""/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>笔记-java中的锁 | kily007</title>
<link rel="shortcut icon" href="https://kily-007.github.io//favicon.ico?v=1591426391494">
<link href="https://cdn.bootcss.com/font-awesome/5.11.2/css/all.css" rel="stylesheet">
<link rel="stylesheet" href="https://kily-007.github.io//styles/main.css">
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
      integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

<script src="https://cdn.bootcss.com/highlight.js/9.15.10/highlight.min.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.15.10/languages/dockerfile.min.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.15.10/languages/dart.min.js"></script>
<script src="https://cdn.bootcss.com/highlight.js/9.15.10/languages/go.min.js"></script>
<script src="https://cdn.bootcss.com/moment.js/2.23.0/moment.min.js"></script>
<script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
        integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
        crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
        integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
        crossorigin="anonymous"></script>

<!-- DEMO JS -->
<!--<script src="media/scripts/index.js"></script>-->



<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?3aca18fa9f3a7e31f0ce64c09c9e5165";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
</head>
<body>
<div class="main gt-bg-theme-color-first">
<div class="main-content">
    <nav class="navbar navbar-expand-lg" style="background:url('/images/background.png');background-repeat: no-repeat;height: 100%;width:100%;">
	
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <i class="fas fa-bars gt-c-content-color-first" style="font-size: 18px"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <div class="navbar-nav mr-auto" style="position: fixed;top:0px;left:0px;float:inherit;background-color:#F5F5F5;height:50px;width:100%;z-index:99;"> 
			<div class="nav-item navbar-brand">
			    <a href="/"><img class="user-avatar" src="/images/avatar.png" alt="头像"></a>
			    <a href="/"><div class="site-name"> kily007</div></a>
			</div>
            
                <div class="nav-item" >
                    
                        <a href="/" class="menu gt-a-links">
                            首页
                        </a>
                    
                </div>
				
				
            
                <div class="nav-item" >
                    
                        <a href="/post/about" class="menu gt-a-links">
                            关于
                        </a>
                    
                </div>
				
				
            
                <div class="nav-item" >
                    
                        <a href="/archives" class="menu gt-a-links">
                            归档
                        </a>
                    
                </div>
				
				
            
                <div class="nav-item" >
                    
                        <a href="/tags" class="menu gt-a-links">
                            标签
                        </a>
                    
                </div>
				
				
            
                <div class="nav-item" >
                    
                        <a href="/neighbor" class="menu gt-a-links">
                            邻居
                        </a>
                    
                </div>
				
				
            
                <div class="nav-item" >
                    
                        <a href="/life" class="menu gt-a-links">
                            生活
                        </a>
                    
                </div>
				
				
            
                <div class="nav-item" >
                    
                        <a href="/message" class="menu gt-a-links">
                            留言
                        </a>
                    
                </div>
				
				
            
        </div>
    </div>
</nav>
    <div class="post-container">
        <div class="post-detail gt-bg-theme-color-second">
            <article class="gt-post-content">
                <h2 class="post-title">
                    笔记-java中的锁
                </h2>
                <div class="post-info">
                    <time class="post-time gt-c-content-color-first">
                        · 2019-08-22 ·
                    </time>
                    
                        <a href="https://kily-007.github.io/tag/X9csAdBxte/" class="post-tags">
                            # java
                        </a>
                    
                </div>
                <div class="post-content">
                    <h1 id="笔记-java中的锁">笔记-java中的锁</h1>
<h2 id="java对象">java对象</h2>
<p>java对象=对象头+实例数据+对其填充</p>
<!--more-->
<h3 id="java对象头">java对象头</h3>
<p>对象头=MarkWord+class pointer+array length(若对象为数组)</p>
<p>锁存在Java对象头里。如果对象是数组类型，则虚拟机用3个Word（字宽）存储对象头，如果对象是非数组类型，则用2字宽存储对象头。在32位虚拟机中，一字宽等于四字节，即32bit。</p>
<pre><code class="language-java">//普通对象：
|-------------------------------- -------------------------|
|                   Object Header (64 bits)                |
|--------------------------------|-------------------------|
|       Mark Word (32 bits)      |    Klass Word (32 bits) |
|--------------------------------|-------------------------|

//数组对象：   
|---------------------------------------------------------------------------------|
|                                 Object Header (96 bits)                         |
|--------------------------------|-----------------------|------------------------|
|        Mark Word(32bits)       |    Klass Word(32bits) |  array length(32bits)  |
|--------------------------------|-----------------------|------------------------|
</code></pre>
<h2 id="对象头的组成">对象头的组成</h2>
<h3 id="mark-word">Mark Word</h3>
<p><strong>32位JVM的Mark Word默认存储结构如下</strong></p>
<figure data-type="image" tabindex="1"><img src="https://blog-1300147267.cos.ap-shanghai.myqcloud.com/%E7%AC%94%E8%AE%B0-java%E4%B8%AD%E7%9A%84%E9%94%81/%E7%AC%94%E8%AE%B0-java%E4%B8%AD%E7%9A%84%E9%94%8101.png" alt="" loading="lazy"></figure>
<h3 id="class-pointer">class pointer</h3>
<p>这一部分用于存储对象的类型指针，该指针指向它的类元数据，JVM通过这个指针确定对象是哪个类的实例。</p>
<h3 id="array-length">array length</h3>
<p>如果对象是一个数组，那么对象头还需要有额外的空间用于存储数组的长度。</p>
<h3 id="总结">总结</h3>
<table>
<thead>
<tr>
<th>长度</th>
<th>内容</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>32/64bit</td>
<td>Mark Word</td>
<td>存储对象的hashCode或锁信息等</td>
</tr>
<tr>
<td>32/64bit</td>
<td>Class Metadata Address</td>
<td>存储到对象类型数据的指针</td>
</tr>
<tr>
<td>32/64bit</td>
<td>Array length</td>
<td>数组的长度（如果当前对象是数组）</td>
</tr>
</tbody>
</table>
<h2 id="自旋锁">自旋锁</h2>
<p><strong>自旋锁原理</strong>：如果持有锁的线程能在很短时间内释放锁资源，那么那些等待竞争锁的线程就不需要做内核态和用户态之间的切换进入阻塞挂起状态，它们只需要等一等（自旋），等持有锁的线程释放锁后即可立即获取锁，这样就<strong>避免用户线程和内核的切换的消耗</strong>。但是线程自旋是需要消耗cup的，说白了就是让cup在做无用功，线程不能一直占用cup自旋做无用功，所以需要设定一个自旋等待的最大时间。如果持有锁的线程执行的时间超过自旋等待的最大时间扔没有释放锁，就会导致其它争用锁的线程在最大等待时间内还是获取不到锁，这时争用线程会停止自旋进入阻塞状态。</p>
<p><strong>自选时间阈值</strong>：自旋锁的目的是为了占着CPU的资源不释放，等到获取到锁立即进行处理。但是如何去选择自旋的执行时间呢？如果自旋执行时间太长，会有大量的线程处于自旋状态占用CPU资源，进而会影响整体系统的性能。因此自旋的周期选的额外重要！</p>
<p>JVM对于自旋周期的选择，jdk1.5这个限度是一定的写死的，在1.6引入了适应性自旋锁，适应性自旋锁意味着自旋的时间不在是固定的了，而是由前一次在同一个锁上的自旋时间以及锁的拥有者的状态来决定，基本认为一个线程上下文切换的时间是最佳的一个时间，同时JVM还针对当前CPU的负荷情况做了较多的优化</p>
<ol>
<li>如果平均负载小于CPUs则一直自旋</li>
<li>如果有超过(CPUs/2)个线程正在自旋，则后来线程直接阻塞</li>
<li>如果正在自旋的线程发现Owner发生了变化则延迟自旋时间（自旋计数）或进入阻塞</li>
<li>如果CPU处于节电模式则停止自旋</li>
<li>自旋时间的最坏情况是CPU的存储延迟（CPU A存储了一个数据，到CPU B得知这个数据直接的时间差）</li>
<li>自旋时会适当放弃线程优先级之间的差异</li>
</ol>
<h2 id="偏向锁">偏向锁</h2>
<p><strong>偏向锁</strong>:简单来说就是一段同步代码块一直被一个线程所访问，那么该线程就会自动获取锁，降低获取锁的代价。</p>
<p>它会偏向最先获得它的线程，当一个线程访问同步代码块获得锁时，会在对象头和栈帧记录里存储锁偏向的线程ID，当这个线程再次进入同步代码块时，就不需要CAS操作来加锁了，只要测试一下对象头里是否存储着指向当前线程的偏向锁。如果测试成功，则表明该线程已经获得了锁，如果失败，则减产偏向锁的标示是否设为1，也就是当前是否是偏向锁，如果是，则尝试用CAS操作将对象头的偏向锁指向当前线程，如果不是，则用CAS竞争锁。</p>
<p><strong>撤销</strong>: 当有其他线程竞争偏向锁的时候，持有偏向锁的线程才会释放锁。当前持有偏向锁的线程如果处于不活动的状态，则直接将对象头设置为无锁状态；如果线程仍然活动，拥有偏向锁的栈会被执行，然后将锁偏向于其他线程，或者恢复到无锁状态。</p>
<p>在没有实际竞争的情况下，还能够针对部分场景继续优化。如果不仅仅没有实际竞争，自始至终，使用锁的线程都只有一个，那么，维护轻量级锁都是浪费的。<strong>偏向锁的目标是，减少无竞争且只有一个线程使用锁的情况下，使用轻量级锁产生的性能消耗</strong>。轻量级锁每次申请、释放锁都至少需要一次CAS，但偏向锁只有初始化时需要一次CAS。</p>
<h2 id="轻量级锁">轻量级锁</h2>
<p><strong>轻量级锁</strong>是由偏向所升级来的，偏向锁运行在一个线程进入同步块的情况下，当第二个线程加入锁争用的时候，偏向锁就会升级为轻量级锁。其它线程会通过自选的形式尝试获取锁，不会阻塞，提高性能。</p>
<p>**优点：**轻量级锁尽可能的减少线程的阻塞，这对于锁的竞争不激烈，且占用锁时间非常短的代码块来说性能能大幅度的提升，因为自旋的消耗会小于线程阻塞挂起再唤醒的操作的消耗，这些操作会导致线程发生两次上下文切换！</p>
<p>**缺点：**但是如果锁的竞争激烈，或者持有锁的线程需要长时间占用锁执行同步块，这时候就不适合使用轻量级锁了，因为轻量级锁在获取锁前一直都是占用cpu做无用功，同时有大量线程在竞争一个锁，会导致获取锁的时间很长，线程自旋的消耗大于线程阻塞挂起操作的消耗，其它需要cup的线程又不能获取到cpu，造成cpu的浪费。所以这种情况下我们要关闭轻量级锁；</p>
<h2 id="重量级锁">重量级锁</h2>
<p><strong>重量级锁</strong>是指当锁为轻量级锁时，另一个线程虽是自旋，自旋一定的次数任然未获得锁就会进入阻塞，该锁膨胀为重量级锁。重量级锁会让其它线程阻塞，降低性能。</p>

                </div>
            </article>
        </div>

        
            <div class="next-post">
                <div class="next gt-c-content-color-first">下一篇</div>
                <a href="https://kily-007.github.io/post/拼多多二面/" class="post-title gt-a-link">
                    拼多多二面
                </a>
            </div>
        

        
		
		
			<script src='https://unpkg.com/valine/dist/Valine.min.js'></script>

<style>
	div#vcomments{
		width:100%;
		max-width: 1000px;
		padding: 2.5%
	}
</style>


	<div id="vcomments"></div>

<script>
	new Valine({
		el: '#vcomments',
		appId: 'C9YP6zy0q66Y54y9XEILvC0C-gzGzoHsz',
		appKey: 'J5I9bBm34OtqU0zFzl9KR4p3',
		avatar: 'monsterid',
		pageSize: 10,
		recordIp: true,
		placeholder: 'Just Go Go'
	});
	if(window.location.hash){
		var checkExist = setInterval(function() {
		   if ($(window.location.hash).length) {
			  $('html, body').animate({scrollTop: $(window.location.hash).offset().top-90}, 1000);
			  clearInterval(checkExist);
		   }
		}, 100);
	}
</script>
		

        <div class="site-footer gt-c-content-color-first">
    <div class="slogan gt-c-content-color-first">啦啦啦，我是卖报的小行家...</div>
    <div class="social-container">
        
            
                <a href="https://github.com/kily-007" target="_blank">
                    <i class="fab fa-github gt-c-content-color-first"></i>
                </a>
            
        
            
        
            
        
            
        
            
        
            
        
    </div>
    <div class="footer-info">
        <div>
	<a href="https://www.zyglz.com"> © 资源管理站</a>
	<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
	<span id="busuanzi_container_site_uv" style='display:none'>访客人数：<span id="busuanzi_value_site_uv"></span>人</span>
	<span id="busuanzi_container_site_pv" style='display:none'>总访问量：<span id="busuanzi_value_site_pv"></span>次</span>
</div>
    </div>
	
    <!--<div>
        Theme by <a href="https://imhanjie.com/" target="_blank">imhanjie</a>, Powered by <a
                href="https://github.com/getgridea/gridea" target="_blank">Gridea | <a href="https://kily-007.github.io//atom.xml" target="_blank">RSS</a></a>
    </div>
	-->
	<span id="sitetime"></span>
	
</div>

<script>
    hljs.initHighlightingOnLoad()
</script>
<script src="//instant.page/3.0.0" type="module" defer integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1"></script>


<script language=javascript>
    function siteTime(){
        window.setTimeout("siteTime()", 1000);
        var seconds = 1000;
        var minutes = seconds * 60;
        var hours = minutes * 60;
        var days = hours * 24;
        var years = days * 365;
        var today = new Date();
        var todayYear = today.getFullYear();
        var todayMonth = today.getMonth()+1;
        var todayDate = today.getDate();
        var todayHour = today.getHours();
        var todayMinute = today.getMinutes();
        var todaySecond = today.getSeconds();
        var t1 = Date.UTC(2019,09,02,21,26,00);  //此处填写建站时间 依次为 年,月,日,时,分,秒注意格式 半角,
        var t2 = Date.UTC(todayYear,todayMonth,todayDate,todayHour,todayMinute,todaySecond);
        var diff = t2-t1;
        var diffYears = Math.floor(diff/years);
        var diffDays = Math.floor((diff/days)-diffYears*365);
        var diffHours = Math.floor((diff-(diffYears*365+diffDays)*days)/hours);
        var diffMinutes = Math.floor((diff-(diffYears*365+diffDays)*days-diffHours*hours)/minutes);
        var diffSeconds = Math.floor((diff-(diffYears*365+diffDays)*days-diffHours*hours-diffMinutes*minutes)/seconds);
        document.getElementById("sitetime").innerHTML="kily007's blog已运行"+diffYears+" 年 "+diffDays+" 天 "+diffHours+" 小时 "+diffMinutes+" 分钟 "+diffSeconds+" 秒";
    }
    siteTime();
</script>
    </div>
</div>
</div>
</body>
</html>
